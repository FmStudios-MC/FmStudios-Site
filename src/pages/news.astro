---
import Layout from '../layouts/Layout.astro';
import Icon from '../components/Icon.astro';
import ScrollReveal from '../components/ScrollReveal.astro';
import NewsCard from '../components/NewsCard.astro';
import Modal from '../components/Modal.astro';
import { blogPosts, newsFilters, blogCategoryConfig } from '../data/news';

const featuredPost = blogPosts[0];
const otherPosts = blogPosts.slice(1);
---

<Layout title="News - FabiMvurice Interactive">
  <section class="max-w-7xl mx-auto px-6 py-12">
    <!-- Header -->
    <ScrollReveal>
      <div class="text-center mb-10">
        <p class="text-xs font-semibold uppercase tracking-widest mb-2" style="color: var(--accent);">Stay Updated</p>
        <h1 class="text-4xl font-black mb-3" style="color: var(--text-primary);">Latest News</h1>
        <p class="max-w-2xl mx-auto" style="color: var(--text-muted);">Announcements, updates, and community news from FabiMvurice Interactive.</p>
      </div>
    </ScrollReveal>

    <!-- Filters -->
    <ScrollReveal>
      <div class="card p-5 mb-8">
        <div class="flex flex-wrap gap-2 justify-center">
          {newsFilters.map((filter, i) => (
            <button
              class:list={['filter-btn news-filter-btn', i === 0 && 'active']}
              data-filter={filter.id}
              aria-pressed={i === 0 ? 'true' : 'false'}
            >
              {filter.label}
            </button>
          ))}
        </div>
      </div>
    </ScrollReveal>

    <!-- Featured Post -->
    <ScrollReveal>
      <div id="featured-post" class="mb-8">
        <NewsCard post={featuredPost} featured={true} />
      </div>
    </ScrollReveal>

    <!-- News Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {otherPosts.map((post, i) => (
        <ScrollReveal delay={i * 80}>
          <NewsCard post={post} />
        </ScrollReveal>
      ))}
    </div>

    <!-- No Posts -->
    <div id="no-posts" class="text-center py-16 hidden">
      <div class="card p-12">
        <Icon name="info" size={48} class="mx-auto mb-4" style="color: var(--text-dim);" />
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-primary);">No posts found</h3>
        <p style="color: var(--text-muted);">Check back later for updates.</p>
      </div>
    </div>
  </section>

  <!-- Blog Modal -->
  <Modal id="blog-modal" />

  <script>
    import { openModal, closeModal } from '../scripts/modal';
    import '../scripts/search';

    const { blogPosts, blogCategoryConfig } = await import('../data/news');

    document.querySelectorAll('.news-card').forEach((card) => {
      card.addEventListener('click', () => {
        const id = Number((card as HTMLElement).dataset.postId);
        const post = blogPosts.find((p) => p.id === id);
        if (!post) return;
        const catConfig = blogCategoryConfig[post.category] || blogCategoryConfig.news;

        // Note: post.content is from trusted local data files.
        // If content sources ever change to user-generated input, add DOMPurify sanitization here.
        const html = `
          <div class="relative">
            <div class="aspect-video overflow-hidden">
              <img src="${post.image}" alt="${post.title}" class="w-full h-full object-cover" />
            </div>
            <button class="modal-close-btn absolute top-4 right-4" aria-label="Close modal">&times;</button>
          </div>
          <div class="p-6 sm:p-8">
            <div class="flex flex-wrap gap-2 mb-3">
              <span class="${catConfig.badge} text-xs font-semibold px-2 py-0.5">${catConfig.label}</span>
              ${post.tags.map((t) => `<span class="text-xs px-2 py-0.5 border border-[var(--border-card)] text-dim">#${t}</span>`).join('')}
            </div>
            <h1 class="text-3xl font-black mb-3 gradient-text">${post.title}</h1>
            <div class="flex items-center gap-4 text-sm mb-6 pb-4 border-b border-[var(--border-card)] text-dim">
              <span>${post.author}</span>
              <span>${post.date}</span>
            </div>
            <div class="blog-content">
              ${post.content}
            </div>
            <div class="mt-6 pt-4 border-t border-[var(--border-card)]">
              <button class="btn-primary inline-flex items-center gap-2 blog-modal-back-btn">
                Back to News
              </button>
            </div>
          </div>
        `;
        openModal('blog-modal', html);

        // Attach close handlers via addEventListener instead of inline onclick
        document.querySelectorAll('#blog-modal .modal-close-btn').forEach((btn) => {
          btn.addEventListener('click', () => closeModal('blog-modal'));
        });
        document.querySelector('#blog-modal .blog-modal-back-btn')?.addEventListener('click', () => {
          closeModal('blog-modal');
        });
      });
    });
  </script>
</Layout>
