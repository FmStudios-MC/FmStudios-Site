---
import Layout from '../layouts/Layout.astro';
import Icon from '../components/Icon.astro';
import ScrollReveal from '../components/ScrollReveal.astro';
import ProjectCard from '../components/ProjectCard.astro';
import Modal from '../components/Modal.astro';
import LightboxModal from '../components/LightboxModal.astro';
import { projects, categories, modpackTypes } from '../data/projects';
---

<Layout title="Projects - FabiMvurice Interactive">
  <section class="max-w-7xl mx-auto px-6 py-12">
    <!-- Header -->
    <ScrollReveal>
      <div class="text-center mb-10">
        <p class="text-xs font-semibold uppercase tracking-widest mb-2" style="color: var(--accent);">Browse</p>
        <h1 class="text-4xl font-black mb-3" style="color: var(--text-primary);">Projects</h1>
        <p class="max-w-2xl mx-auto" style="color: var(--text-muted);">Explore our Minecraft modpacks, mods, and resource packs.</p>
      </div>
    </ScrollReveal>

    <!-- Search & Filters -->
    <ScrollReveal>
      <div class="card p-6 mb-8">
        <!-- Search -->
        <div class="relative max-w-xl mx-auto mb-6">
          <Icon name="search" size={18} class="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none" style="color: var(--text-dim);" />
          <input
            type="text"
            id="search-input"
            placeholder="Search projects, features, versions..."
            class="search-input w-full pl-11 pr-4 py-3 text-sm"
            aria-label="Search projects"
          />
        </div>

        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 justify-center mb-4">
          {categories.map((cat, i) => (
            <button
              class:list={['filter-btn category-filter-btn', i === 0 && 'active']}
              data-filter={cat.id}
              aria-pressed={i === 0 ? 'true' : 'false'}
            >
              {cat.label}
            </button>
          ))}
        </div>

        <!-- Modpack Sub-Filters -->
        <div id="modpack-filter" class="flex flex-wrap gap-2 justify-center" style="display: none;">
          {modpackTypes.map((type, i) => (
            <button
              class:list={['filter-btn modpack-filter-btn text-xs', i === 0 && 'active']}
              data-filter={type.id}
              aria-pressed={i === 0 ? 'true' : 'false'}
            >
              {type.label}
            </button>
          ))}
        </div>

        <!-- Results count -->
        <div class="mt-4 text-center">
          <span id="results-count" class="text-xs" style="color: var(--text-dim);"></span>
        </div>
      </div>
    </ScrollReveal>

    <!-- Projects Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {projects.map((project, i) => (
        <ScrollReveal delay={i * 80}>
          <ProjectCard project={project} />
        </ScrollReveal>
      ))}
    </div>

    <!-- No Results -->
    <div id="no-results" class="text-center py-16" style="display: none;">
      <div class="card p-12">
        <Icon name="search" size={48} class="mx-auto mb-4" style="color: var(--text-dim);" />
        <h3 class="text-xl font-bold mb-2" style="color: var(--text-primary);">No projects found</h3>
        <p style="color: var(--text-muted);">Try adjusting your search or filter criteria.</p>
      </div>
    </div>
  </section>

  <!-- Project Modal -->
  <Modal id="project-modal" />

  <!-- Lightbox -->
  <LightboxModal />

  <script>
    import { openModal, closeModal } from '../scripts/modal';
    import { renderProjectModalHtml } from '../scripts/project-modal';
    import { openLightbox } from '../scripts/lightbox';
    import '../scripts/search';

    const projectData = {
      projects: (await import('../data/projects')).projects,
      statusConfig: (await import('../data/projects')).statusConfig,
    };

    document.querySelectorAll('.project-card').forEach((card) => {
      card.addEventListener('click', () => {
        const id = Number((card as HTMLElement).dataset.projectId);
        const project = projectData.projects.find((p) => p.id === id);
        if (!project) return;

        const status = projectData.statusConfig[project.status];
        const html = renderProjectModalHtml(project, status);
        openModal('project-modal', html);

        // Attach close handler to modal close button
        document.querySelector('#project-modal .modal-close-btn')?.addEventListener('click', () => {
          closeModal('project-modal');
        });

        // Attach lightbox triggers for screenshots
        document.querySelectorAll('#project-modal .lightbox-trigger').forEach((img, i) => {
          img.addEventListener('click', () => {
            const srcs = project.screenshots.map((s, idx) => ({
              src: s,
              alt: `${project.name} screenshot ${idx + 1}`,
            }));
            openLightbox(srcs, i);
          });
        });
      });
    });
  </script>
</Layout>
