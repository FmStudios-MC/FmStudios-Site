// Social media links
const socialLinks = [
    {
        name: 'X (Twitter)',
        url: 'https://x.com/famvinteractive',
        icon: '<svg class="w-5 h-5" fill="#fff" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>'
    },
    {
        name: 'YouTube',
        url: 'https://www.youtube.com/@fm-studios-mc',
        icon: '<svg class="w-5 h-5" fill="#FF0000" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>'
    },
    {
        name: 'Bluesky',
        url: 'https://bsky.app/profile/fmstudios.bsky.social',
        icon: '<svg class="w-5 h-5" fill="#00A8E8" viewBox="0 0 24 24"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.019-.275.039-.415.058-2.67-.297-5.568.628-6.383 3.364C.378 17.805 0 22.247 0 22.935c0 .688.139 1.861.902 2.204.659.299 1.664.621 4.3-1.239 2.752-1.942 5.711-5.881 6.798-7.995 1.087 2.114 4.046 6.053 6.798 7.995 2.636 1.86 3.641 1.538 4.3 1.239.763-.343.902-1.516.902-2.204 0-.688-.378-5.13-.624-5.958-.815-2.736-3.713-3.661-6.383-3.364-.14-.019-.277-.039-.415-.058.14.017.279.036.415.056 2.67.296 5.568-.628 6.383-3.364.246-.829.624-5.789.624-6.479 0-.688-.139-1.86-.902-2.203-.659-.299-1.664-.621-4.3 1.238C16.046 4.747 13.087 8.686 12 10.8z"/></svg>'
    },
    {
        name: 'Discord',
        url: 'https://discord.gg/x9jsed8qyR',
        icon: '<svg class="w-5 h-5" fill="#5865F2" viewBox="0 0 24 24"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0189 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1568 2.4189Z"/></svg>'
    },
    {
        name: 'Instagram',
        url: 'https://www.instagram.com/fabimvurice.interactive',
        icon: '<svg class="w-5 h-5" fill="url(#instagram-gradient)" viewBox="0 0 24 24"><defs><linearGradient id="instagram-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f09433;stop-opacity:1"/><stop offset="25%" style="stop-color:#e6683c;stop-opacity:1"/><stop offset="50%" style="stop-color:#dc2743;stop-opacity:1"/><stop offset="75%" style="stop-color:#cc2366;stop-opacity:1"/><stop offset="100%" style="stop-color:#bc1888;stop-opacity:1"/></linearGradient></defs><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>'
    },
    {
        name: 'TikTok',
        url: 'https://www.tiktok.com/@fabimvurice.interactive',
        icon: '<svg class="w-5 h-5" fill="#fff" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>'
    }
];

const platformLinks = [
    {
        name: 'CurseForge',
        url: 'https://www.curseforge.com/members/fabimvurice_interactive/projects',
        gradient: 'from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700',
        shadow: 'shadow-orange-500/50'
    },
    {
        name: 'Modrinth',
        url: 'https://modrinth.com/user/FabiMvurice_Interactive',
        gradient: 'from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700',
        shadow: 'shadow-emerald-500/50',
        icon: '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 512 514"><path fill-rule="evenodd" clip-rule="evenodd" d="M503.16 323.56C514.55 281.47 515.32 235.91 503.2 190.76C466.57 54.2299 326.04 -26.8001 189.33 9.77991C83.8101 38.0199 11.3899 128.07 0.689941 230.47H43.99C54.29 147.33 113.74 74.7298 199.75 51.7098C306.05 23.2598 415.13 80.6699 453.17 181.38L411.03 192.65C391.64 145.8 352.57 111.45 306.3 96.8198L298.56 140.66C335.09 154.13 364.72 184.5 375.56 224.91C391.36 283.8 361.94 344.14 308.56 369.17L320.09 412.16C390.25 383.21 432.4 310.3 422.43 235.14L464.41 223.91C468.91 252.62 467.35 281.16 460.55 308.07L503.16 323.56Z" fill="currentColor"/><path d="M321.99 504.22C185.27 540.8 44.7501 459.77 8.11011 323.24C3.84011 307.31 1.17 291.33 0 275.46L43.27 275.5C44.36 287.37 46.4699 299.35 49.6799 311.29C53.0399 323.8 57.45 335.75 62.79 347.07L101.38 323.92C98.1299 316.42 95.39 308.6 93.21 300.47C69.17 210.87 122.41 118.77 212.13 94.7601C229.13 90.2101 246.23 88.4401 262.93 89.1501L255.19 133C244.73 133.05 234.11 134.42 223.53 137.25C157.31 154.98 118.01 222.95 135.75 289.09C136.85 293.16 138.13 297.13 139.59 300.99L188.94 271.38L174.07 231.95L220.67 184.08L279.57 171.39L296.62 192.38L269.47 219.88L245.79 227.33L228.87 244.72L237.16 267.79C237.16 267.79 253.95 285.63 253.98 285.64L277.7 279.33L294.58 260.79L331.44 249.12L342.42 273.82L304.39 320.45L240.66 340.63L212.08 308.81L162.26 338.5C187.8 367.78 226.2 383.93 266.01 380.56L277.54 423.55C218.13 431.41 160.1 406.82 124.05 361.64L85.6399 384.68C136.25 451.17 223.84 484.11 309.61 461.16C371.35 444.64 419.4 402.56 445.42 349.38L488.06 364.88C457.17 431.16 398.22 483.82 321.99 504.22Z" fill="currentColor"/></svg>'
    }
];

const supportLinks = [
    {
        name: 'Tebex Shop (Soon)',
        url: '',
        gradient: 'from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700',
        icon: '<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'
    },
    {
        name: 'Kinetic Hosting',
        url: 'https://billing.kinetichosting.net/aff.php?aff=855',
        gradient: 'from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700',
        icon: '<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'
    }
];

// Optimierte Render-Funktionen
function renderSocialLinks() {
    const container = document.getElementById('social-links');
    if (!container) return;
    
    const fragment = document.createDocumentFragment();
    
    socialLinks.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'social-btn glass rounded-xl px-6 py-3 flex items-center space-x-3 transition-all relative z-10';
        a.setAttribute('aria-label', `Visit ${link.name}`);
        a.innerHTML = `${link.icon}<span class="text-white font-medium">${link.name}</span>`;
        fragment.appendChild(a);
    });
    
    platformLinks.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = `social-btn rounded-xl px-8 py-4 flex items-center space-x-3 bg-gradient-to-r ${link.gradient} transition-all shadow-lg ${link.shadow} relative z-10`;
        a.setAttribute('aria-label', `Visit ${link.name}`);
        a.innerHTML = `${link.icon || ''}<span class="text-white font-bold text-lg">${link.name}</span>`;
        fragment.appendChild(a);
    });
    
    container.appendChild(fragment);
}

function renderSupportLinks() {
    const container = document.getElementById('support-links');
    if (!container) return;
    
    const fragment = document.createDocumentFragment();
    
    supportLinks.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url;
        if (link.url) {
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
        } else {
            a.onclick = (e) => e.preventDefault();
        }
        a.className = `social-btn rounded-xl px-8 py-4 text-white font-semibold transition-all bg-gradient-to-r ${link.gradient} relative z-10`;
        a.setAttribute('aria-label', link.name);
        a.innerHTML = `${link.icon}${link.name}`;
        fragment.appendChild(a);
    });
    
    container.appendChild(fragment);
}

function renderFooterSocial() {
    const container = document.getElementById('footer-social');
    if (!container) return;
    
    const fragment = document.createDocumentFragment();
    
    socialLinks.forEach(link => {
        const a = document.createElement('a');
        a.href = link.url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'social-btn glass rounded-xl px-5 py-3 flex items-center space-x-2 transition-all relative z-10';
        a.setAttribute('aria-label', `Visit ${link.name}`);
        a.innerHTML = `${link.icon}<span class="text-white text-sm font-medium">${link.name}</span>`;
        fragment.appendChild(a);
    });
    
    container.appendChild(fragment);
}

function renderCategoryFilters() {
    const categories = [
        { id: 'all', label: 'All Projects' },
        { id: 'modpacks', label: 'Modpacks' },
        { id: 'mods', label: 'Mods' },
        { id: 'resourcepacks', label: 'Resource Packs' }
    ];
    
    const container = document.getElementById('category-filters');
    if (!container) return;
    
    const fragment = document.createDocumentFragment();
    
    categories.forEach(cat => {
        const button = document.createElement('button');
        button.onclick = () => filterProjects(cat.id);
        button.className = `category-btn ${cat.id === 'all' ? 'active gradient-accent' : 'glass'} rounded-xl px-8 py-3 font-semibold transition-all text-white`;
        button.setAttribute('aria-pressed', cat.id === 'all' ? 'true' : 'false');
        button.textContent = cat.label;
        fragment.appendChild(button);
    });
    
    container.appendChild(fragment);
}

function renderModpackFilters() {
    const modpackTypes = [
        { id: 'all', label: 'All Types' },
        { id: 'vanilla+', label: 'Vanilla+' },
        { id: 'tech', label: 'Tech' },
        { id: 'magic', label: 'Magic' },
        { id: 'adventure', label: 'Adventure' }
    ];
    
    const container = document.getElementById('modpack-filter');
    if (!container) return;
    
    const fragment = document.createDocumentFragment();
    
    modpackTypes.forEach(type => {
        const button = document.createElement('button');
        button.onclick = () => filterModpacks(type.id);
        button.className = `modpack-btn ${type.id === 'all' ? 'active gradient-accent' : 'glass'} text-sm rounded-xl px-6 py-2 transition-all text-white font-medium`;
        button.setAttribute('aria-pressed', type.id === 'all' ? 'true' : 'false');
        button.textContent = type.label;
        fragment.appendChild(button);
    });
    
    container.appendChild(fragment);
}

// Throttle-Funktion
function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

// Lazy Loading f체r Partikel - nur Desktop
let particlesCreated = false;
function createParticles() {
    if (particlesCreated || window.innerWidth < 768) return;
    
    particlesCreated = true;
    const container = document.getElementById('particles');
    if (!container) return;
    
    const particleCount = 8; // Stark reduziert von 25
    const fragment = document.createDocumentFragment();
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 5 + 's';
        particle.style.animationDuration = (Math.random() * 10 + 15) + 's'; // L채ngere Dauer
        particle.style.opacity = Math.random() * 0.3 + 0.2;
        fragment.appendChild(particle);
    }
    
    container.appendChild(fragment);
}

// Theme state
let currentTheme = 'dark';

// Theme toggle functionality
function toggleTheme() {
    const html = document.documentElement;
    const isLight = html.classList.contains('light-theme');

    if (isLight) {
        html.classList.remove('light-theme');
        currentTheme = 'dark';
    } else {
        html.classList.add('light-theme');
        currentTheme = 'light';
    }

    // Save preference to localStorage
    localStorage.setItem('theme', currentTheme);
}

function initTheme() {
    // Check for saved preference
    const savedTheme = localStorage.getItem('theme');

    // Check for system preference if no saved preference
    if (savedTheme) {
        currentTheme = savedTheme;
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
        currentTheme = 'light';
    }

    // Apply theme
    if (currentTheme === 'light') {
        document.documentElement.classList.add('light-theme');
    }

    // Listen for system theme changes
    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
            // Only auto-switch if user hasn't set a preference
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    document.documentElement.classList.add('light-theme');
                    currentTheme = 'light';
                } else {
                    document.documentElement.classList.remove('light-theme');
                    currentTheme = 'dark';
                }
            }
        });
    }
}

// Initialize
function init() {
    // Initialize theme first to prevent flash
    initTheme();

    // Initialize filtered projects
    filteredProjects = [...projects];

    // Lazy load particles nur auf Desktop
    requestIdleCallback(() => {
        if (window.innerWidth >= 768) {
            createParticles();
        }
    });

    renderSocialLinks();
    renderSupportLinks();
    renderFooterSocial();
    renderCategoryFilters();
    renderModpackFilters();
    renderProjects();
    renderChangelog();
    renderRoadmapFilters();
    renderRoadmap();
    renderNewsFilters();
    renderFeaturedPost();
    renderNews();
    renderKineticHosting();
    updateResultsCount();
    setupScrollEffects();

    // Throttled Scroll-Handler
    window.addEventListener('scroll', throttle(handleScroll, 150), { passive: true });

    // Modal close handlers
    setupModalHandlers();

    // ESC key handler
    document.addEventListener('keydown', handleEscKey, { passive: true });

    // Setup FAB
    const fab = document.querySelector('.floating-action');
    if (fab) {
        fab.style.opacity = '0';
        fab.style.pointerEvents = 'none';
    }
}

function setupModalHandlers() {
    const modals = [
        { id: 'project-modal', close: closeModal },
        { id: 'lightbox', close: closeLightbox },
        { id: 'blog-modal', close: closeBlogModal }
    ];
    
    modals.forEach(({ id, close }) => {
        const modal = document.getElementById(id);
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) close();
            });
        }
    });
}

function handleEscKey(e) {
    if (e.key !== 'Escape') return;

    const lightbox = document.getElementById('lightbox');
    const projectModal = document.getElementById('project-modal');
    const blogModal = document.getElementById('blog-modal');

    if (lightbox && !lightbox.classList.contains('hidden')) {
        closeLightbox();
    } else if (blogModal && !blogModal.classList.contains('hidden')) {
        closeBlogModal();
    } else if (projectModal && !projectModal.classList.contains('hidden')) {
        closeModal();
    }
}

// Intersection Observer f체r Lazy Loading
const observerOptions = {
    threshold: 0.1,
    rootMargin: '50px'
};

let scrollObserver;

function setupScrollEffects() {
    if (scrollObserver) {
        scrollObserver.disconnect();
    }
    
    scrollObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                scrollObserver.unobserve(entry.target); // Nur einmal
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.glow-on-scroll').forEach(el => scrollObserver.observe(el));
}

// Start when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

// Fallback f체r requestIdleCallback
if (!window.requestIdleCallback) {
    window.requestIdleCallback = function(cb) {
        return setTimeout(cb, 1);
    };
}
